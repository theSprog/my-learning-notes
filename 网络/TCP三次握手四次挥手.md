## TCP 协议

TCP协议是在**传输层** 的 **端到端**的传输协议



## 三次握手

<img src="https://src-1259777572.cos.ap-chengdu.myqcloud.com/image-20230221170044512.png" alt="image-20230221170044512" style="zoom:50%;" />

上图中每一次过程所发送的报文都包含着 `Seq` 序列号。



- ### 一次握手

  > 由客户端发起，客户端向服务端发出申请，报文中包含两个关键字段：
  >
  > - `SYN`：表示请求同步
  >
  > - `Seq(x)`：表示本次报文的序号，因为发送方可能同一时段发送多条信息，所以用 `Seq(x)` 表示发送方发送的字节流顺序。
  >
  >   > TCP把数据流分区成适当长度的报文段（长度受 MTU 上限的限制），然后用序列号 `Seq` 表示报文顺序

- ### 二次握手

  > 服务端收到客户端请求后
  >
  > - 自己也生成一个序号 `Seq(y)`
  > - 同时返回确认收到标记 `ACK`，它的值是发送方报文序号加一（即 `Seq(x)+1`），用于表示向发送方确认自己已收到对应序号为 `Seq(x)` 的报文

- ### 三次握手

  > 由于服务端不知道自己发送的报文是否被客户端收到，因此客户端需要再发送一次确认报文
  >
  > - 序列号为 `Seq(x+1)`，因为上次序列号为 `Seq(x)`，所以显然下一个报文就应该是 `Seq(x+1)`
  > - 携带 `ACK` 号为上次握手时服务端发送的 `Seq(y)+1`，表示对方发送的确认报文已收到



### DOS 攻击

由于客户端发送请求通信后，服务端都要记住客户端所发送报文的序号，并且根据序号生成对应的 `ACK`（即 `Seq+1`）。那么假如有一位黑客不断发生 `SYN` 请求通信，又不进行下一步操作，那么服务器马上会因为短时间内接受了大量垃圾请求而被打击瘫痪（DOS攻击）。

这其中的关键就是服务端必须对所有请求的序号保存一段时间，而这段时间内所有的请求都属于半连接状态，服务器无法随便丢弃，所以导致服务器内存占满。



## 四次挥手

<img src="https://src-1259777572.cos.ap-chengdu.myqcloud.com/image-20230221171830444.png" alt="image-20230221171830444" style="zoom: 50%;" />

之所以要四次挥手，是因为即使客户端已经没有数据要发送了，服务端也有可能还有数据没有发送完毕。等到服务端数据发送完毕后，服务端自己就会发送标志位 `FIN` 表示结束

第二次挥手和第三次挥手的 `ACK` 号码是一样的，因为这期间客户端已经无报文发送，所以不存在 `Seq` 增大的情形，自然这两次挥手的 `ACK` 确认号相同。